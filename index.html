<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>GÃ©nÃ©rateur de Mails - Circet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background: #0d1b2a; /* bleu nuit foncÃ© */
  color: #f4f4f4;
  margin: 0;
  padding: 20px;
}

header {
  background: linear-gradient(135deg, #ff7a00, #b85c00);
  padding: 15px 20px;
  display: flex;
  align-items: center;
  color: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  border-radius: 8px;
  margin-bottom: 25px;
}

header img {
  height: 60px;
  margin-right: 20px;
  border-radius: 6px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.6); /* relief */
  background: rgba(0,0,0,0.2); /* lÃ©ger contraste */
  padding: 4px; /* contour autour du logo */
}

h1 {
  font-size: 26px;
  font-weight: bold;
  margin: 0;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
}

h2 {
  margin-top: 30px;
  color: #ffb347;
  border-left: 5px solid #ff7a00;
  padding-left: 10px;
}

section {
  background: #1b263b; /* bleu nuit clair */
  padding: 20px;
  margin-bottom: 25px;
  border-radius: 10px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.5);
}

label {
  display: block;
  margin: 10px 0 5px;
  font-weight: 600;
  color: #ffb347;
}

/* Inputs & selects */
select, input[type="date"], input[type="text"], textarea {
  width: 100%;
  max-width: 600px;
  padding: 10px;
  border: none;
  border-radius: 8px;
  outline: none;
  font-size: 14px;
  background: #0d1b2a;
  color: #f4f4f4;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
  transition: all 0.3s;
}

/* Pour amÃ©liorer lisibilitÃ© du calendrier natif */
input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1) sepia(1) saturate(5) hue-rotate(180deg); 
  cursor: pointer;
}

select:focus, input:focus, textarea:focus {
  box-shadow: 0 0 8px #ff7a00;
  background: #14243a;
}

textarea {
  min-height: 70px;
  resize: vertical;
}

.button {
  margin-top: 12px;
  background: linear-gradient(135deg, #ff7a00, #e65c00);
  color: #fff;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  letter-spacing: 0.5px;
  box-shadow: 0 5px 10px rgba(0,0,0,0.4);
  transition: all 0.25s ease;
}

.button:hover {
  background: linear-gradient(135deg, #ff9633, #ff7a00);
  transform: translateY(-2px);
  box-shadow: 0 8px 15px rgba(0,0,0,0.6);
}

.button:active {
  transform: translateY(1px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.4);
}

.recipients {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.recipients textarea {
  flex: 1;
}

.row {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  align-items: flex-end;
}

.hint {
  font-size: 12px;
  color: #aaa;
  margin-top: 6px;
}

  </style>
</head>
<body>
  <header>
    <img src="https://i.imgur.com/gfK7XhS.png" alt="Logo Circet">
    <h1>GÃ©nÃ©rateur de mails Circet Orange Fibre</h1>
  </header>

  <!-- Section GÃ©nÃ©ration -->
  <section>
    <div class="row">
      <div>
        <label>Type de mail :</label>
        <select id="typeMail"></select>
      </div>

      <div>
        <label>RÃ©gion :</label>
        <select id="region"></select>
      </div>

      <div>
        <label>Date :</label>
        <input type="date" id="date" />
      </div>

      <div>
        <label>Heure :</label>
        <select id="heure">
          <option>10h</option>
          <option>12h</option>
          <option>14h</option>
          <option>15h30</option>
          <option>16h</option>
          <option>18h</option>
        </select>
      </div>
    </div>

    <label>ðŸ“§ Destinataires :</label>
    <div class="recipients">
      <textarea id="toEmails" placeholder="email1@circet.fr; email2@circet.fr"></textarea>
      <button class="button" onclick="handleImport('toEmails')">ðŸ“‚ Importer destinataires</button>
      <input type="file" id="importTo" style="display:none" accept=".xls,.xlsx" onchange="importEmailsFromExcel(this, 'toEmails')" />
    </div>

    <label>ðŸ“¤ En copie (CC) :</label>
    <div class="recipients">
      <textarea id="ccEmails" placeholder="chef@circet.fr; controle@circet.fr"></textarea>
      <button class="button" onclick="handleImport('ccEmails')">ðŸ“‚ Importer en copie (CC)</button>
      <input type="file" id="importCC" style="display:none" accept=".xls,.xlsx" onchange="importEmailsFromExcel(this, 'ccEmails')" />
    </div>

    <button class="button" onclick="genererMail()">ðŸ“§ GÃ©nÃ©rer le mail</button>
  </section>

  <!-- Section RÃ©sultat -->
  <section>
    <h2>Objet du mail :</h2>
    <textarea id="objet" readonly></textarea>

    <h2>Corps du mail :</h2>
    <textarea id="corps" readonly></textarea>

    <button class="button" onclick="ouvrirOutlook()">ðŸ“¤ Ouvrir dans Outlook (texte + signature)</button>
  </section>

  <!-- Section Gestion -->
  <section>
    <h2>âž• Gestion des mappings (Types/RÃ©gions)</h2>
    <label>Type de mail :</label>
    <input type="text" id="newType" placeholder="ex: Avancement ou nouveau type" />

    <label>RÃ©gion :</label>
    <input type="text" id="newRegion" placeholder="ex: IDF ou vide si national" />

    <label>Corps du mail :</label>
    <textarea id="newBody" placeholder="Texte par dÃ©faut pour ce type/rÃ©gion"></textarea>

    <button class="button" onclick="ajouterTypeRegion()">âž• Ajouter au menu</button>
  </section>

  <script>
    const modeles = {
      "Avancement": {
        objet: "Avancement prod {REGION} {DATE}",
        corps: "{MESSAGE}\nAvancement Ã  {HEURE} ci-dessous, dÃ©tails en PJ."
      },
      "Compte Rendu": {
        objet: "Compte rendu {REGION} {DATE}",
        corps: "Bonjour Ã  tous,\nCompte rendu du jour ci-dessous, dÃ©tails en PJ."
      },
      "Planning": {
        objet: "Planning Ã  chaud {REGION} {DATE}",
        corps: "Bonsoir,\nVous trouverez en PJ. le planning de la journÃ©e de demain."
      },
     "Planification": {
  objet: "Planification {REGION} {DATE}",
  corps: "Bonjour Ã  tous,\n\nVous trouverez en P.J. les interventions planifiÃ©es pour la journÃ©e de demain."
},

      "SynthÃ¨se du soir": {
        objet: "SynthÃ¨se {DATE} {REGION}",
        corps: "Bonjour,\nVous trouverez ci-dessous un aperÃ§u des indicateurs du jour."
      },
      "SynthÃ¨se nationale Lot1": {
        objet: "SynthÃ¨se nationale Lot1 {DATE}",
        corps: "Bonjour,\nVous trouverez ci-dessous un aperÃ§u de la synthÃ¨se nationale."
      },
      "Vision Flash": {
        objet: "Vision flash lot 1 {REGION} S{SEMAINE}",
        corps: "Bonjour Ã  tous,\nSynthÃ¨se S{SEMAINE} ci-dessous, dÃ©tails en PJ. *Chiffres en cours de consolidation"
      }
    };

    // --- Sauvegarde / Chargement menus ---
    function chargerMenus() {
      let saved = JSON.parse(localStorage.getItem("mappingsMenus")) || { types: [], regions: [], bodies: {} };

      const selectType = document.getElementById("typeMail");
      const selectRegion = document.getElementById("region");

      // valeurs de base
      const baseTypes = Object.keys(modeles);
      const baseRegions = ["IDF","CVL","Corse","Lot 2 PDL","74/01","63/03","PRM"];

      [...baseTypes, ...saved.types].forEach(t => {
        if (![...selectType.options].some(o => o.value === t)) {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          selectType.appendChild(opt);
        }
      });

      [...baseRegions, ...saved.regions].forEach(r => {
        if (![...selectRegion.options].some(o => o.value === r)) {
          const opt = document.createElement("option");
          opt.value = r;
          opt.textContent = r;
          selectRegion.appendChild(opt);
        }
      });
    }

    function ajouterTypeRegion() {
      const type = document.getElementById("newType").value.trim();
      const region = document.getElementById("newRegion").value.trim();
      const body = document.getElementById("newBody").value.trim();
      if (!type) { alert("Type obligatoire"); return; }

      let saved = JSON.parse(localStorage.getItem("mappingsMenus")) || { types: [], regions: [], bodies: {} };
      if (!saved.types.includes(type)) saved.types.push(type);
      if (region && !saved.regions.includes(region)) saved.regions.push(region);

      let key = region ? `${type}_${region}` : type;
      saved.bodies[key] = body;

      localStorage.setItem("mappingsMenus", JSON.stringify(saved));
      alert("AjoutÃ© et sauvegardÃ© ! Recharge la page pour voir le menu mis Ã  jour.");
    }

    // --- Reste (Excel, normalisation, gÃ©nÃ©ration) ---
    let lastExcelFile = null;
    let mappings = [];

    function getMatchingKey() {
      const type = document.getElementById("typeMail").value.trim();
      const region = document.getElementById("region").value.trim();
      if (type === "SynthÃ¨se nationale Lot1") return type.toLowerCase();
      return `${type} ${region}`.toLowerCase();
    }

    function normalizeEmails(str) {
      if (!str) return [];
      return str.replace(/[ \t]/g, '').replace(/[\n\r]+/g, ';')
        .replace(/,+/g, ';').replace(/;{2,}/g, ';').replace(/^;|;$/g, '')
        .split(';').map(e => e.trim()).filter(e => e.length > 0);
    }

    function handleImport(targetId) {
      if (lastExcelFile) {
        importEmailsFromExcel({ files: [lastExcelFile] }, targetId);
      } else {
        if (targetId === 'toEmails') document.getElementById('importTo').click();
        else document.getElementById('importCC').click();
      }
    }
function getMailSheet(workbook) {
  const sheetName = workbook.SheetNames.find(n =>
    n.toLowerCase().includes("mail")
  );
  return sheetName ? workbook.Sheets[sheetName] : null;
}

function normalizeKey(str) {
  return (str || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // enlÃ¨ve accents
    .replace(/\s+/g, " ")
    .trim();
}


  

 function importEmailsFromExcel(input, targetId) {
  if (input && input.files && input.files[0]) {
    lastExcelFile = input.files[0];
  }
  if (!lastExcelFile) {
    alert("Veuillez sÃ©lectionner un fichier Excel.");
    return;
  }

  const TYPES_SANS_REGION = [
    "compte rendu",
    "synthese nationale lot1"
  ];

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });

    // --- RÃ©cupÃ©ration onglet Mail ---
    const sheet = getMailSheet(workbook);
    if (!sheet) {
      alert("Aucun onglet contenant 'mail' trouvÃ© dans l'Excel");
      return;
    }

    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 }).slice(1);

    const typeUI   = normalizeKey(document.getElementById("typeMail").value);
    const regionUI = normalizeKey(document.getElementById("region").value);

    let found = false;

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];

      const typeExcel = normalizeKey(row[0]); // Col A : Type Mail
      const descExcel = normalizeKey(row[1]); // Col B : Description Mail

      // --- Match type ---
      const typeMatch =
        typeExcel.includes(typeUI) || typeUI.includes(typeExcel);

      if (!typeMatch) continue;

      // --- Gestion rÃ©gion ---
      const ignoreRegion = TYPES_SANS_REGION.includes(typeUI);
      const regionMatch = ignoreRegion || descExcel.includes(regionUI);

      if (!regionMatch) continue;

      // --- RÃ©cupÃ©ration emails ---
      const imported =
        targetId === "toEmails" ? row[2] : row[3]; // C = TO / D = CC

      document.getElementById(targetId).value =
        normalizeEmails(imported || "").join("; ");

      found = true;
      break;
    }

    if (!found) {
      document.getElementById(targetId).value = "";
      alert(
        "Aucune correspondance trouvÃ©e dans l'Excel pour : " +
        document.getElementById("typeMail").value +
        " " +
        document.getElementById("region").value
      );
    }
  };

  reader.readAsArrayBuffer(lastExcelFile);
}


    function getFormattedDate(date) {
      if (!date) return "JJ/MM/AAAA";
      const d = new Date(date);
      return isNaN(d) ? "JJ/MM/AAAA" : d.toLocaleDateString('fr-FR');
    }

    function getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
      const week1 = new Date(d.getFullYear(), 0, 4);
      return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    }

    function genererMail() {
      const type = document.getElementById("typeMail").value;
      const region = document.getElementById("region").value;
      const date = document.getElementById("date").value;
      if (!date) { alert("Merci de sÃ©lectionner une date."); return; }
      const heure = document.getElementById("heure").value;
      const semaine = getWeekNumber(date);
      const dateStr = getFormattedDate(date);

      let objetTpl = modeles[type]?.objet || "{TYPE} {REGION} {DATE}";
      let corpsTpl = modeles[type]?.corps || "Message auto";

      // VÃ©rifier si un corps personnalisÃ© existe
      let saved = JSON.parse(localStorage.getItem("mappingsMenus")) || { bodies: {} };
      let key = region ? `${type}_${region}` : type;
      if (saved.bodies[key]) {
        corpsTpl = saved.bodies[key];
      }

      let message = "";
      if (type === "Avancement" && heure === "10h") {
        message = "Bonjour Ã  tous,";
      }

      const replacements = {
        "{REGION}": region,
        "{DATE}": dateStr,
        "{HEURE}": heure,
        "{SEMAINE}": semaine,
        "{MESSAGE}": message,
        "{TYPE}": type
      };

      for (const token in replacements) {
        objetTpl = objetTpl.replaceAll(token, replacements[token]);
        corpsTpl = corpsTpl.replaceAll(token, replacements[token]);
      }

      document.getElementById("objet").value = objetTpl.trim();
      document.getElementById("corps").value = corpsTpl.trim();
    }

    function ouvrirOutlook() {
      const toRaw = document.getElementById("toEmails").value.trim();
      const ccRaw = document.getElementById("ccEmails").value.trim();
      const subject = document.getElementById("objet").value.trim();
      let bodyText = document.getElementById("corps").value.trim();
      const to = normalizeEmails(toRaw).join('; ');
      const cc = normalizeEmails(ccRaw).join('; ');
      bodyText = bodyText.replace(/\n/g, '\r\n');
      const mailto = `mailto:${encodeURIComponent(to)}?cc=${encodeURIComponent(cc)}` +
                     `&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}`;
      window.location.href = mailto;
    }

    window.onload = chargerMenus;
  </script>
</body>
</html>




